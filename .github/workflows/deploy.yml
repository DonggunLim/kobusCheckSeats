name: Deploy to Home Server (SSH Push)

on:
  push:
    branches:
      - main

# 2. 환경 변수: 이미지 이름을 편하게 쓰기 위해 설정
env:
  APP_IMAGE_NAME: ghcr.io/donggunlim/kobuscheckseat:app-latest
  WORKER_IMAGE_NAME: ghcr.io/donggunlim/kobuscheckseat:worker-latest
  # ❗ 홈서버에 프로젝트가 위치할 경로
  PROJECT_PATH_ON_SERVER: /srv/kobusCheckSeats

jobs:
  # ----------------------------------------
  # 첫 번째 작업: 이미지 빌드 및 GHCR 푸시
  # ----------------------------------------
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      # 코드 체크아웃
      - name: Checkout code
        uses: actions/checkout@v4

      # Docker QEMU 설정 (멀티 플랫폼 빌드용, 권장)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # Docker Buildx 설정 (빌드 캐시 등)
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # GHCR 로그인
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.APP_GITHUB_TOKEN }}

      # App 이미지 빌드 및 푸시 (target: prod-app)
      - name: Build and push App image
        uses: docker/build-push-action@v6
        with:
          context: .
          dockerfile: Dockerfile
          target: prod-app
          push: true
          tags: ${{ env.APP_IMAGE_NAME }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Worker 이미지 빌드 및 푸시 (target: prod-worker)
      - name: Build and push Worker image
        uses: docker/build-push-action@v6
        with:
          context: .
          dockerfile: Dockerfile
          target: prod-worker
          push: true
          tags: ${{ env.WORKER_IMAGE_NAME }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ----------------------------------------
  # 두 번째 작업: SSH 접속 및 배포
  # ----------------------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      # SSH 접속 및 배포 스크립트 실행
      - name: Deploy to Home Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          # 1. 접속 정보 (GitHub Secrets에서 가져옴)
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.PORT }}

          # 2. 홈서버에서 실행할 명령어 스크립트
          script: |
            # 홈서버의 프로젝트 폴더로 이동 (없으면 생성)
            mkdir -p ${{ env.PROJECT_PATH_ON_SERVER }}
            cd ${{ env.PROJECT_PATH_ON_SERVER }}

            # docker-compose.prod.yml 파일 가져오기 (GitHub에서 직접 다운로드)
            curl -L -o docker-compose.yml https://raw.githubusercontent.com/DonggunLim/kobusCheckSeats/main/docker-compose.prod.yml

            # .env 파일 생성 (GitHub Secrets 사용)
            echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" > .env
            echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> .env
            echo "GITHUB_TOKEN=${{ secrets.APP_GITHUB_TOKEN }}" >> .env
            echo "GITHUB_REPOSITORY=${{ secrets.APP_GITHUB_REPOSITORY }}" >> .env

            # GHCR 로그인 (홈서버가 이미지를 PULL 할 수 있도록)
            echo "${{ secrets.APP_GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # 최신 이미지 내려받기
            docker pull ${{ env.APP_IMAGE_NAME }}
            docker pull ${{ env.WORKER_IMAGE_NAME }}

            # Docker Compose 실행 (worker 2개 스케일링 포함)
            docker compose up -d --force-recreate --scale worker=2

            # 불필요한 옛날 이미지 정리
            docker system prune -f
