# ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„ (GitHub 'Actions' íƒ­ì— í‘œì‹œë©ë‹ˆë‹¤)
name: Bus Seat Checker

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë  ì¡°ê±´ì„ ì •ì˜í•©ë‹ˆë‹¤
on:
  # 1. ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (í•„ìš”ì‹œ ì£¼ì„ í•´ì œ)
  # schedule:
  #   # cron í‘œí˜„ì‹ì„ ì‚¬ìš©í•˜ì—¬ 5ë¶„ë§ˆë‹¤ ì‹¤í–‰í•©ë‹ˆë‹¤.
  #   # [ì£¼ì˜] ë„ˆë¬´ ì¦ì€ ì‹¤í–‰ì€ GitHub ì •ì±…ì— ì˜í•´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  #   # ì•ˆì •ì ì¸ ìš´ì˜ì„ ìœ„í•´ 15ë¶„ ì´ìƒ ê°„ê²©('*/15 * * * *')ì„ ê¶Œì¥í•©ë‹ˆë‹¤.
  #   - cron: "*/5 * * * *"

  # 2. ìˆ˜ë™ ì‹¤í–‰ (Actions íƒ­ì—ì„œ 'Run workflow' ë²„íŠ¼ìœ¼ë¡œ ì§ì ‘ ì‹¤í–‰)
  workflow_dispatch:
    inputs:
      departure:
        description: "ì¶œë°œì§€"
        required: false
        type: string
      arrival:
        description: "ë„ì°©ì§€"
        required: false
        type: string
      targetMonth:
        description: "ëª©í‘œ ì›” (ì˜ˆ: 11)"
        required: false
        type: string
      targetDate:
        description: "ëª©í‘œ ì¼ (ì˜ˆ: 5)"
        required: false
        type: string
      targetTimes:
        description: "ëª©í‘œ ì‹œê°„ (ì‰¼í‘œë¡œ êµ¬ë¶„, ì˜ˆ: 18:40,19:40)"
        required: false
        type: string

# ì‹¤í–‰í•  ì‘ì—…(job) ëª©ë¡ì„ ì •ì˜í•©ë‹ˆë‹¤
jobs:
  # 'check'ë¼ëŠ” ì´ë¦„ì˜ ì‘ì—…ì„ ì •ì˜í•©ë‹ˆë‹¤
  check:
    # ì´ ì‘ì—…ì€ ìµœì‹  ë²„ì „ì˜ Ubuntu ê°€ìƒ í™˜ê²½ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤
    runs-on: ubuntu-latest

    # ì‘ì—… ë‚´ì—ì„œ ì‹¤í–‰ë  ë‹¨ê³„(step)ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì •ì˜í•©ë‹ˆë‹¤
    steps:
      - name: ğŸ•µï¸ Check GitHub Actions Runner IP and Environment
        run: |
          echo "================================================="
          echo "               1. IP Information                 "
          echo "================================================="
          curl ipinfo.io
          echo ""
          echo "DNS Servers:"
          cat /etc/resolv.conf | grep nameserver || echo "No DNS info"
          echo ""

          echo "================================================="
          echo "            2. System Resources                  "
          echo "================================================="
          echo "ğŸ–¥ï¸  CPU Info:"
          lscpu | grep -E "Model name|CPU\(s\):|Thread|Core" || echo "CPU info unavailable"
          echo ""
          echo "ğŸ’¾ Memory:"
          free -h
          echo ""
          echo "ğŸ’¿ Disk Space:"
          df -h /
          echo ""

          echo "================================================="
          echo "            3. OS & Environment Info             "
          echo "================================================="
          echo "OS: $(lsb_release -d 2>/dev/null | cut -f2 || uname -a)"
          echo "Kernel: $(uname -r)"
          echo "Runner OS: $RUNNER_OS"
          echo "Runner Architecture: $RUNNER_ARCH"
          echo "GitHub Actor: $GITHUB_ACTOR"
          echo "Working Directory: $(pwd)"
          echo "Timezone: $(cat /etc/timezone 2>/dev/null || echo "Unknown")"
          echo "Current Time: $(date)"
          echo "Current Time (UTC): $(date -u)"
          echo ""

          echo "================================================="
          echo "            4. Network Connectivity Test         "
          echo "================================================="
          echo "ğŸŒ Testing connection to kobus.co.kr..."
          curl -s -o /dev/null -w "HTTP Status: %{http_code}\nTotal Time: %{time_total}s\nDNS Lookup: %{time_namelookup}s\nConnect Time: %{time_connect}s\n" https://www.kobus.co.kr/mrs/rotinf.do || echo "âŒ Connection failed"
          echo ""
          echo "ğŸŒ Testing general internet connectivity..."
          curl -s -o /dev/null -w "Google HTTP Status: %{http_code}\n" https://www.google.com || echo "âŒ Google connection failed"
          echo ""

          echo "================================================="
          echo "            5. Installed Browser Info            "
          echo "================================================="
          echo "Chrome/Chromium versions:"
          which google-chrome && google-chrome --version || echo "Chrome not installed yet"
          which chromium && chromium --version || echo "Chromium not installed yet"
          which chromium-browser && chromium-browser --version || echo "Chromium-browser not installed yet"
          echo ""

          echo "================================================="
          echo "            6. Workflow Inputs                   "
          echo "================================================="
          echo "ğŸ“‹ Departure: ${{ inputs.departure || 'Not set (will use DEFAULT_CONFIG)' }}"
          echo "ğŸ“‹ Arrival: ${{ inputs.arrival || 'Not set (will use DEFAULT_CONFIG)' }}"
          echo "ğŸ“‹ Target Month: ${{ inputs.targetMonth || 'Not set (will use DEFAULT_CONFIG)' }}"
          echo "ğŸ“‹ Target Date: ${{ inputs.targetDate || 'Not set (will use DEFAULT_CONFIG)' }}"
          echo "ğŸ“‹ Target Times: ${{ inputs.targetTimes || 'Not set (will use DEFAULT_CONFIG)' }}"
          echo "================================================="

          # ëª¨ë“  í™˜ê²½ ë³€ìˆ˜ë¥¼ ë³´ë ¤ë©´ ì•„ë˜ ì£¼ì„ì„ í•´ì œí•˜ì„¸ìš” (ë¡œê·¸ê°€ ê¸¸ì–´ì§)
          # echo "================================================="
          # echo "             7. All Environment Variables        "
          # echo "================================================="
          # env | sort

      # 1ë‹¨ê³„: ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ê°€ìƒ í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤
      - name: Checkout repository code
        uses: actions/checkout@v4

      # 2ë‹¨ê³„: Node.js í™˜ê²½ì„ ì„¤ì •í•©ë‹ˆë‹¤
      - name: Set up Node.js environment
        uses: actions/setup-node@v4
        with:
          # ìŠ¤í¬ë¦½íŠ¸ì™€ í˜¸í™˜ë˜ëŠ” Node.js ë²„ì „ì„ ì§€ì •í•©ë‹ˆë‹¤
          node-version: "20"

      # 3ë‹¨ê³„: npmìœ¼ë¡œ í”„ë¡œì íŠ¸ ì˜ì¡´ì„±(playwright)ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤
      - name: Install dependencies
        run: npm install

      # 4ë‹¨ê³„: Playwrightê°€ ì‚¬ìš©í•  ë¸Œë¼ìš°ì €ì™€ ì‹œìŠ¤í…œ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤ (ë§¤ìš° ì¤‘ìš”!)
      - name: Install Playwright Browsers and dependencies
        run: npx playwright install --with-deps

      # 4.5ë‹¨ê³„: í™˜ê²½ ë³€ìˆ˜ ì „ë‹¬ í™•ì¸ (ë””ë²„ê¹…ìš©)
      - name: ğŸ” Verify Environment Variables
        run: |
          echo "================================================="
          echo "         Environment Variables Check             "
          echo "================================================="
          echo "DEPARTURE: '${{ inputs.departure }}' -> ENV: '$DEPARTURE'"
          echo "ARRIVAL: '${{ inputs.arrival }}' -> ENV: '$ARRIVAL'"
          echo "TARGET_MONTH: '${{ inputs.targetMonth }}' -> ENV: '$TARGET_MONTH'"
          echo "TARGET_DATE: '${{ inputs.targetDate }}' -> ENV: '$TARGET_DATE'"
          echo "TARGET_TIMES: '${{ inputs.targetTimes }}' -> ENV: '$TARGET_TIMES'"
          echo "================================================="
        env:
          DEPARTURE: ${{ inputs.departure }}
          ARRIVAL: ${{ inputs.arrival }}
          TARGET_MONTH: ${{ inputs.targetMonth }}
          TARGET_DATE: ${{ inputs.targetDate }}
          TARGET_TIMES: ${{ inputs.targetTimes }}

      # 5ë‹¨ê³„: ì‘ì„±í•œ ì¢Œì„ í™•ì¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤
      - name: Run the seat check script
        run: npm run check
        env:
          DEPARTURE: ${{ inputs.departure }}
          ARRIVAL: ${{ inputs.arrival }}
          TARGET_MONTH: ${{ inputs.targetMonth }}
          TARGET_DATE: ${{ inputs.targetDate }}
          TARGET_TIMES: ${{ inputs.targetTimes }}

      # 6ë‹¨ê³„: ê²°ê³¼ë¥¼ ì €ì¥ì†Œì— ì»¤ë°‹í•©ë‹ˆë‹¤ (íˆìŠ¤í† ë¦¬ ë° ì„¸ì…˜ ë°ì´í„° ë³´ì¡´)
      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add data/history.json
          [ -f data/session.json ] && git add data/session.json || true
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update seat check data [skip ci]" && git push)
